<!doctype html> 
<html>
  <head>
    <meta charset="utf-8" />
    <meta content="IE=edge;chrome=1" http-equiv="X-UA-Compatible" />
    <title>My gh-pages | Browsing Task Dependencies in the Rakefile of mruby using jsTree</title>
    <meta content="<p>Building mruby is not just about compiling C sources and linking objects together but also contains some nontrivial steps like invocation of mrbc that is also built with the mruby build system.
The Rakefiles of mruby are not easy read. To get a better grasp of what the task dependency structure looks like, I had to create a visual aid below.</p>

<p>" name="description" />
    <link rel="alternate" type="application/atom+xml" title="Atom Feed" href="/feed.xml" /><!--[if lt IE 9]><script src="../../../js/ie8.js" type="text/javascript"></script><![endif]--><link href="../../../css/all.css" media="screen" rel="stylesheet" type="text/css" /><script src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML" type="text/javascript"></script>
  </head>
  <body>
    <nav class="navbar navbar-inverse navbar-fixed-top" role="navigation">
      <div class="container">
        <div class="navbar-header">
          <button class="navbar-toggle" data-target=".navbar-ex1-collapse" data-toggle="collapse" type="button"><span class="sr-only">Toggle navigation</span><span class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span></button><a class="navbar-brand" href="/">My gh-pages</a>
        </div>
        <div class="collapse navbar-collapse navbar-ex1-collapse">
          <ul class="nav navbar-nav">
            <li>
              <a href="https://github.com/shinaisan"> About</a>
            </li>
            <li>
              <a href="https://github.com/shinaisan"><i class="fa fa-github-square fa-lg fa-inverse"></i></a>
            </li>
          </ul>
        </div>
      </div>
    </nav>
    <div class="container">
      <div class="row">
        <div class="col-lg-3 col-md-3">
          <div class="well">
            <h4>
              Tags
            </h4>
            <ul class="list-unstyled">
              <li>
                <a href="/tags/git.html">Git</a> (1)
              </li>
              <li>
                <a href="/tags/snippet.html">Snippet</a> (5)
              </li>
              <li>
                <a href="/tags/gdb.html">GDB</a> (1)
              </li>
              <li>
                <a href="/tags/debugging.html">Debugging</a> (1)
              </li>
              <li>
                <a href="/tags/mqtt.html">MQTT</a> (1)
              </li>
              <li>
                <a href="/tags/mosquitto.html">Mosquitto</a> (1)
              </li>
              <li>
                <a href="/tags/network.html">Network</a> (1)
              </li>
              <li>
                <a href="/tags/protocol.html">Protocol</a> (1)
              </li>
              <li>
                <a href="/tags/python.html">Python</a> (1)
              </li>
              <li>
                <a href="/tags/ruby.html">Ruby</a> (4)
              </li>
              <li>
                <a href="/tags/mruby.html">mruby</a> (1)
              </li>
              <li>
                <a href="/tags/javascript.html">JavaScript</a> (2)
              </li>
              <li>
                <a href="/tags/graph.html">graph</a> (1)
              </li>
              <li>
                <a href="/tags/visualization.html">visualization</a> (1)
              </li>
              <li>
                <a href="/tags/nlp.html">NLP</a> (1)
              </li>
              <li>
                <a href="/tags/wordnet.html">WordNet</a> (1)
              </li>
              <li>
                <a href="/tags/c.html">C++</a> (2)
              </li>
              <li>
                <a href="/tags/algorithm.html">Algorithm</a> (2)
              </li>
              <li>
                <a href="/tags/aws.html">AWS</a> (1)
              </li>
              <li>
                <a href="/tags/ubuntu.html">Ubuntu</a> (1)
              </li>
              <li>
                <a href="/tags/rbenv.html">rbenv</a> (1)
              </li>
              <li>
                <a href="/tags/middleman.html">Middleman</a> (1)
              </li>
              <li>
                <a href="/tags/bindata.html">BinData</a> (1)
              </li>
            </ul>
          </div>
          <div class="well">
            <h4>
              By year
            </h4>
            <ol>
              <li>
                <a href="/2017.html">2017</a> (1)
              </li>
              <li>
                <a href="/2015.html">2015</a> (9)
              </li>
            </ol>
          </div>
        </div>
        <div class="col-lg-9 col-md-9">
          <h1>
            Browsing Task Dependencies in the Rakefile of mruby using jsTree
          </h1>
          <small class="label label-default">Ruby</small>
          <small class="label label-default">mruby</small>
          <small class="label label-default">JavaScript</small>
          <hr />
          <p>
            <span class="glyphicon glyphicon-time"></span> Posted on Dec 22
          </p>
          <hr /><p>Building mruby is not just about compiling C sources and linking objects together but also contains some nontrivial steps like invocation of mrbc that is also built with the mruby build system.
The Rakefiles of mruby are not easy read. To get a better grasp of what the task dependency structure looks like, I had to create a visual aid below.</p>

<p></p>

<h3 id="browsing-dependency-tree-strucutre">Browsing Dependency Tree Strucutre</h3>

<div>
<script type="text/javascript" src="http://jsdo.it/blogparts/Cf9i/js?width=800&amp;height=496&amp;view=readme"></script>
</div>

<p>This tree view allows us to navigate from the root <code>all</code> node to every task it depends. Some nodes are links to another node that is typically a library or a tool that is referred from many other tasks. This linking feature is for preventing the tree from repeating the same substructures and eventually growing too big.</p>

<p>Some nodes contain additional information that is displayed on the right side. Currently it contains only "defining actions" indicating the location of its definition.</p>

<p>By traversing the tree structure, I could make some inferences below whether they be correct or not â€¦</p>

<h4 id="libmrubya-forms-the-basis-for-the-main-executable-targets">libmruby.a forms the basis for the main executable targets</h4>

<p><img alt="libmruby.a" src="../../../images/img-2015-12-22/libmruby_a.png" /></p>

<ul>
  <li><code>mruby</code> and <code>mirb</code> depend on it.</li>
  <li><code>mrbc</code> does not but depends on <code>libmruby_core.a</code> that looks much alike <code>libmruby.a</code> but does not contain mrbgems.</li>
  <li><code>mrbtest</code> depends on both <code>libmruby.a</code> and <code>libmruby_core.a</code> for some reason. (Would someone please tell me why?)</li>
</ul>

<h4 id="mrbc-is-used-to-generate-geminitc"><code>mrbc</code> is used to generate geminit.c</h4>

<p><img alt="mrbc" src="../../../images/img-2015-12-22/geminit_c_and_mrbc.png" /></p>

<p>For example, <code>mrbgems/mruby-sprintf/gem_init.o</code> seems to be compiled from <code>gem_init.c</code> that depends on <code>mrbc</code> and a Ruby script in <code>mrblib</code>.
This suggests that <code>mrbc</code> generates a part of or all of the <code>gem_init.c</code>.
Browsing the C source soon reveals a byte-code looking code snippet that presumably is the output of <code>mrbc</code> taking the mrblib as an input.
I am not sure why <code>gem_init.c</code> depends on <code>tasks/mrbgem_spec.rake</code>.</p>

<h4 id="the-ruby-scripts-in-testt-convert-into-c-source-to-build-mrbtest">The Ruby scripts in <code>test/t/</code> convert into C source to build <code>mrbtest</code></h4>

<p><img alt="mrbtest" src="../../../images/img-2015-12-22/mrbtest_Dependency.png" /></p>

<p>It was not clear to me what the scripts in <code>test/t</code> directory are for.
The dependency tree gave me a hint that the <code>mrbc</code> tool is used to generate a part of <code>mrbtest</code>. The <code>mrbtest</code> tool depends also on <code>mrbtest.a</code> that seems to be a collection of <code>gem_test.o</code>-s. Again, by walking down into each of their subtrees, another use case of <code>mrbc</code> can be found.</p>

<h3 id="about-data-extraction-and-visualization">About Data Extraction and Visualization</h3>

<h4 id="ruby">Ruby</h4>

<p><a href="https://gist.github.com/shinaisan/c3a359334c2f8ae137d4">This script (Gist)</a> extracts the task dependencies of mruby.</p>

<ol>
  <li>The script tries collecting all the tasks defined in the Rakefile. My first bet was that <code>MiniRake::Task.tasks</code> would do the trick but actually it does not. I had to recursively traverse the dependency tree with the help of the <code>prerequisites</code> parameter of a task. The method <code>Jstree::TaskInfo.all</code> is written to this end and is called from the constructor of <code>Jstree::Graph</code> that is the main class of the above script.</li>
  <li>An instance of <code>Jstree::Graph</code> has nodes each of which represents one of the tasks in the Rakefile but does not have edges. The instance method <code>construct</code> gives edges to the dependency graph instance.</li>
  <li>The instance method <code>to_json</code> is called after the graph construction. Its first parameter takes the root task name. Its second parameter <code>roots</code> takes names of tasks that are treated as leaf nodes that stop recursive call to the method. The <code>roots</code> parameter is intended to serve as a list of root task names each of which is passed to the method as its first argument.</li>
</ol>

<h4 id="javascript">JavaScript</h4>

<p>The above Ruby script <code>jstree.rb</code> produces a JSON file <code>jstree.json</code>. This JSON file contains the definition of a variable <code>json</code> (<code>var json = [ ... ];</code>) that can be directly supplied to the jsTree library like below:</p>

<pre class="highlight javascript"><code>    <span class="nx">$</span><span class="p">(</span><span class="s2">"#tree-view-area"</span><span class="p">).</span><span class="nx">jstree</span><span class="p">({</span>
        <span class="s2">"core"</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">"data"</span><span class="p">:</span> <span class="nx">json</span>
        <span class="p">}</span>
    <span class="p">});</span>
</code></pre>
<p>Here is the excerpt of the JSON file. In the following JSON data, only the <code>text</code> and <code>children</code> parameters matter to jsTree. The <code>info</code> parameter is something like an extra user parameter.
The <code>jstree</code> function does not care about it and seems to drop such extra parameters from the object returned by the <a href="https://www.jstree.com/api/#/?f=get_node"><code>get_node</code> API</a>.
Luckily however, it holds the original JSON data in the <code>original</code> parameter. So my own <code>info</code> parameter can be accessed in such a way as to say <code>data.instance.get_node(data.selected[0]).original.info</code> in jsTree event handlers.
There is also another extra parameter <code>jump</code> in the output (not in the excerpt below) that is used to implement jumping from node to node.</p>

<pre class="highlight javascript"><code><span class="kd">var</span> <span class="nx">json</span> <span class="o">=</span> <span class="p">[</span>
    <span class="c1">// snip</span>
      <span class="p">{</span>
        <span class="s2">"text"</span><span class="p">:</span> <span class="s2">"build/host/src/array.o"</span><span class="p">,</span>
        <span class="s2">"info"</span><span class="p">:</span> <span class="p">{</span> <span class="s2">"defining_actions"</span><span class="p">:</span> <span class="p">[</span><span class="s2">"tasks/mruby_build_commands.rake:104"</span><span class="p">]</span> <span class="p">},</span>
        <span class="s2">"children"</span><span class="p">:</span> <span class="p">[</span>
          <span class="p">{</span>
            <span class="s2">"text"</span><span class="p">:</span> <span class="s2">"src/array.c"</span><span class="p">,</span>
            <span class="s2">"info"</span><span class="p">:</span> <span class="p">{</span> <span class="s2">"defining_actions"</span><span class="p">:</span> <span class="p">[]</span> <span class="p">},</span>
            <span class="s2">"children"</span><span class="p">:</span> <span class="p">[]</span>
          <span class="p">},</span>
          <span class="p">{</span>
            <span class="s2">"text"</span><span class="p">:</span> <span class="s2">"build_config.rb"</span><span class="p">,</span>
            <span class="s2">"info"</span><span class="p">:</span> <span class="p">{</span> <span class="s2">"defining_actions"</span><span class="p">:</span> <span class="p">[]</span> <span class="p">},</span>
            <span class="s2">"children"</span><span class="p">:</span> <span class="p">[]</span>
          <span class="p">}</span>
        <span class="p">]</span>
      <span class="p">},</span>
    <span class="c1">// snip</span>
<span class="p">];</span>
</code></pre>
<h3 id="references">References</h3>

<ul>
  <li><a href="https://github.com/mruby/mruby">mruby/mruby - GitHub</a></li>
  <li><a href="https://www.jstree.com/">jsTree</a></li>
</ul>


          <aside>
            <h3>
              Recent Articles
            </h3>
            <ol>
              <li>
                <a href="/2017/05/06/cytoscape-js-powered-interactive-graph-visualization-of-wordnet-synsets.html">Cytoscape.js powered Interactive Graph Visualization of WordNet Synsets</a> <span>May  6</span> 
              </li>
              <li>
                <a href="/2015/12/22/browsing-task-dependencies-in-the-rakefile-of-mruby-using-jstree.html">Browsing Task Dependencies in the Rakefile of mruby using jsTree</a> <span>Dec 22</span> 
              </li>
              <li>
                <a href="/2015/10/06/inspecting-the-retransmission-behavior-of-the-mosquitto-mqtt-broker-with-gdb.html">Inspecting the Retransmission Behavior of the Mosquitto MQTT Broker with GDB</a> <span>Oct  6</span> 
              </li>
              <li>
                <a href="/2015/08/05/example-of-read_until-parameter-of-bindata-array.html">Example of read_until parameter of BinData::Array</a> <span>Aug  5</span> 
              </li>
              <li>
                <a href="/2015/08/02/trying-out-git-submodule.html">Trying out git-submodule</a> <span>Aug  2</span> 
              </li>
              <li>
                <a href="/2015/08/01/0-1-knapsack-problem-sample-implementation.html">0-1 Knapsack Problem Sample Implementation</a> <span>Aug  1</span> 
              </li>
              <li>
                <a href="/2015/07/31/some-practice-examples-of-range-minimum-query-rmq.html">Some Practice Examples of Range Minimum Query (RMQ)</a> <span>Jul 31</span> 
              </li>
              <li>
                <a href="/2015/07/11/setting-up-python-virtualenv-with-virtualenvwrapper-on-ubuntu-ec2.html">Setting up Python virtualenv with virtualenvwrapper on Ubuntu/EC2</a> <span>Jul 11</span> 
              </li>
              <li>
                <a href="/2015/06/16/building-and-installing-ruby-with-rbenv-on-ubuntu-ec2.html">Building and Installing Ruby with rbenv on Ubuntu/EC2</a> <span>Jun 16</span> 
              </li>
              <li>
                <a href="/2015/06/03/starting-a-blog-with-middleman.html">Starting a Blog with Middleman</a> <span>Jun  3</span> 
              </li>
            </ol>
          </aside>
          <hr>
            <p class="text-center">
              2015 <a href="/">My gh-pages</a>
            </p>
          </hr>
        </div>
      </div>
    </div>
    <script src="../../../js/all.js" type="text/javascript"></script>
  </body>
</html>